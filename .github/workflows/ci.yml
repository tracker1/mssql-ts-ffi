name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  typescript:
    name: TypeScript (lint, check, test)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - name: Format check
        run: deno fmt --check

      - name: Lint
        run: deno lint

      - name: Type check
        run: deno check projects/mssql/mod.ts

      - name: Unit tests
        run: deno test --allow-env projects/mssql/

  rust:
    name: Rust (check, clippy, fmt)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: projects/rust
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: projects/rust -> target

      - name: Check
        run: cargo check

      - name: Clippy
        run: cargo clippy -- -D warnings

      - name: Format check
        run: cargo fmt --check

      - name: Unit tests
        run: cargo test

  integration:
    name: Integration tests
    runs-on: ubuntu-latest
    needs: [typescript, rust]
    services:
      mssql:
        image: mcr.microsoft.com/mssql/server:2025-latest
        env:
          ACCEPT_EULA: "Y"
          MSSQL_SA_PASSWORD: "DevPassword1!"
        ports:
          - 1433:1433
        options: >-
          --health-cmd "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P 'DevPassword1!' -C -Q 'SELECT 1'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
    steps:
      - uses: actions/checkout@v4

      - uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: projects/rust -> target

      - name: Build native library
        run: cargo build --release
        working-directory: projects/rust

      - name: Copy library to project root
        run: |
          cp projects/rust/target/release/libmssqlts.so ./mssqlts-linux-x86_64.so

      - name: Run integration tests
        env:
          MSSQL_TEST_ENABLED: "1"
          MSSQL_TEST_CONNECTION: "Server=localhost;Database=master;User Id=sa;Password=DevPassword1!;TrustServerCertificate=true;"
        run: >
          deno test
          --allow-env
          --allow-net
          --allow-ffi
          --allow-read
          projects/test/integration/deno/
